document.addEventListener('DOMContentLoaded', () => {
  // PARTICLES
  const particlesConfig = {
    particles:{number:{value:80,density:{enable:true,value_area:800}},color:{value:'#ffffff'},shape:{type:'circle'},
      opacity:{value:0.5,random:true,anim:{enable:true,speed:0.4,opacity_min:0.1,sync:false}},
      size:{value:2.5,random:true,anim:{enable:false}},
      line_linked:{enable:true,distance:150,color:'#ffffff',opacity:0.2,width:1},
      move:{enable:true,speed:1.2,direction:'none',random:true,straight:false,out_mode:'out',bounce:false}},
    interactivity:{detect_on:'canvas',events:{onhover:{enable:true,mode:'repulse'},onclick:{enable:false},resize:true},
      modes:{repulse:{distance:80,duration:0.4}}},retina_detect:true
  };
  if (typeof particlesJS !== 'undefined') particlesJS('particles-js', particlesConfig);

  // ===== BASES =====
  const FUNCS_BASE = document.querySelector('meta[name="functions-base"]')?.content?.trim() || '/.netlify/functions';
  const CALENDLY_URL = document.querySelector('meta[name="calendly-url"]')?.content?.trim() || '';
  const APPLE_PASS_URL = document.querySelector('meta[name="apple-wallet-pass"]')?.content?.trim() || '';
  const GOOGLE_WALLET_JWT = document.querySelector('meta[name="google-wallet-jwt"]')?.content?.trim() || '';

  const fnUrl = (name) => `${FUNCS_BASE.replace(/\/+$/,'')}/${name}`;

  // Utils
  const $  = (s) => document.querySelector(s);
  const $$ = (s) => document.querySelectorAll(s);
  const play = (el) => { if(!el) return; el.currentTime=0; el.play().catch(()=>{}); };
  const ga = (...args) => { try { window.gtag && window.gtag(...args); } catch(_) {} };

  const CANON = location.origin + location.pathname.replace(/index\.html$/,'');
  const withUTM = (base, params) => {
    const u = new URL(base, location.origin);
    Object.entries(params||{}).forEach(([k,v]) => u.searchParams.set(k, v));
    return u.toString();
  };

  // Origine per prefill
  const params = new URLSearchParams(location.search);
  const source = params.get('src') || params.get('utm_source') || 'direct';
  const originFieldHidden = $('#origin-field');
  if (originFieldHidden) originFieldHidden.value = source;

  // ELEMENTI
  const cardContainer = $('#card-container');
  const cardFlipper   = $('#card-flipper');
  const promptOverlay = $('#prompt-overlay');
  const shareOverlay  = $('#share-overlay');
  const saveOverlay   = $('#save-overlay');

  const consultOverlay = $('#consult-overlay');
  const consultForm    = $('#consult-form');
  const consultStatus  = $('#consult-status');
  const durationChips  = $$('#duration-chips .chip-select');
  const consultDate    = $('#consult-date');
  const consultTime    = $('#consult-time');
  const consultName    = $('#consult-name');
  const consultEmail   = $('#consult-email');
  const consultPhone   = $('#consult-phone');
  const consultSubject = $('#consult-subject');
  const consultMessage = $('#consult-message');

  const sfxClick  = $('#sfx-click');
  const sfxFlip   = $('#sfx-flip');
  const sfxPrompt = $('#sfx-prompt');

  // Install prompt
  let deferredPrompt = null;
  const installButtons = $$('.install-btn');

  const isIOS = () => /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
  const isStandalone = () => ('standalone' in navigator) && navigator.standalone;
  const isMobile = () => window.matchMedia('(max-width: 480px)').matches;

  // ===== SHARE =====
  const updateShareLinks = () => {
    const shareBase = CANON;
    const wa   = withUTM(shareBase, {utm_source:'whatsapp',utm_medium:'share',utm_campaign:'business-card',src:'whatsapp'});
    const tg   = withUTM(shareBase, {utm_source:'telegram',utm_medium:'share',utm_campaign:'business-card',src:'telegram'});
    const fb   = withUTM(shareBase, {utm_source:'facebook',utm_medium:'share',utm_campaign:'business-card',src:'facebook'});
    const mail = withUTM(shareBase, {utm_source:'email',utm_medium:'share',utm_campaign:'business-card',src:'email'});

    const text = encodeURIComponent("Scopri la business card di Digital Tower!");
    const w = $('#share-whatsapp'), t = $('#share-telegram'), f = $('#share-facebook'), m = $('#share-email');
    if (w) w.href = `https://api.whatsapp.com/send?text=${text}%20${encodeURIComponent(wa)}`;
    if (t) t.href = `https://t.me/share/url?url=${encodeURIComponent(tg)}&text=${text}`;
    if (f) f.href = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(fb)}`;
    if (m) m.href = `mailto:?subject=${encodeURIComponent('Digital Tower - Business Card')}&body=${encodeURIComponent('Guarda la card: '+mail)}`;

    const sc = $('#share-copy');
    if (sc) {
      sc.addEventListener('click', (e)=>{
        e.preventDefault();
        setTimeout(async () => {
          try{
            await navigator.clipboard.writeText(withUTM(shareBase,{utm_source:'copy',utm_medium:'share',utm_campaign:'business-card',src:'copy'}));
            e.currentTarget?.classList?.add('copied'); setTimeout(()=>e.currentTarget?.classList?.remove('copied'),1200);
          }catch{
            // fallback non bloccante
            const old = sc.title; sc.title = 'Copiato!';
            setTimeout(()=>{ sc.title = old; }, 1200);
          }
        }, 0);
      });
    }
  };

  // Trigger Condividi (bind a ID front/back per evitare inversioni)
  const attachShareTriggers = () => {
    const bindShare = (btnId) => {
      const btn = document.getElementById(btnId);
      if (!btn) return;
      btn.addEventListener('click', ()=>{
        play(sfxClick);
        const url = withUTM(CANON,{utm_source:'native-share',utm_medium:'share',utm_campaign:'business-card',src:'native'});
        const data={title:'Digital Tower - Business Card', text:'Scopri la business card di Digital Tower!', url};
        // non bloccare il click handler
        setTimeout(async () => {
          if(navigator.share){
            try { await navigator.share(data); ga('event','share_native'); return; }
            catch(e){ if(e && e.name==='AbortError') return; }
          }
          shareOverlay?.classList?.remove('hidden');
        }, 0);
      });
    };
    bindShare('share-trigger-front');
    bindShare('share-trigger-back');
  };

  // Install PWA prompt
  function showInstallPrompt(){
    installButtons.forEach(btn => btn.style.display='flex');
    if (isIOS() && !isStandalone()) setTimeout(()=>$('#ios-install-prompt')?.classList?.add('is-visible'), 3000);
  }
  window.addEventListener('beforeinstallprompt', (e) => {
    deferredPrompt = e; // niente preventDefault -> niente warning
    showInstallPrompt();
  });

  // Prompt iniziale
  function handleInitialPrompt(shouldDownload){
    play(sfxPrompt);
    if (shouldDownload){
      setTimeout(() => {
        const a=document.createElement('a');
        a.href='roberto_business.vcf'; a.download='digital_tower.vcf';
        document.body.appendChild(a); a.click(); a.remove();
      }, 0);
    }
    promptOverlay?.classList?.add('hidden');
    cardContainer?.classList?.add('is-visible');
    showInstallPrompt();
  }
  $('#prompt-yes')?.addEventListener('click', ()=>handleInitialPrompt(true));
  $('#prompt-no') ?.addEventListener('click', ()=>handleInitialPrompt(false));

  // Close overlays / ESC
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') [shareOverlay,saveOverlay,consultOverlay].forEach(o=>o?.classList?.add('hidden')); });
  [shareOverlay,saveOverlay,consultOverlay].forEach(ov=>{
    ov?.addEventListener('click', (e)=>{ if(e.target===ov) { play(sfxClick); ov.classList?.add('hidden'); } });
  });
  $('#close-share-btn') ?.addEventListener('click', ()=>{ play(sfxClick); shareOverlay?.classList?.add('hidden'); });
  $('#close-save-btn')  ?.addEventListener('click', ()=>{ play(sfxClick); saveOverlay ?.classList?.add('hidden'); });
  $('#close-consult-btn')?.addEventListener('click', ()=>{ play(sfxClick); consultOverlay?.classList?.add('hidden'); });

  // Flip
  const flip = () => {
    requestAnimationFrame(() => {
      play(sfxFlip);
      const flipped = cardFlipper?.classList?.toggle('is-flipped');
      ga('event','flip_card',{to: flipped ? 'personal':'agency'});
    });
  };
  let x0=0,x1=0;
  cardContainer?.addEventListener('touchstart', e=>{ x0=e.changedTouches[0].screenX; }, {passive:true});
  cardContainer?.addEventListener('touchend',   e=>{ x1=e.changedTouches[0].screenX; if(Math.abs(x1-x0)>=50) flip(); }, {passive:true});
  document.addEventListener('click', (e)=>{
    const b=e.target.closest?.('.flip-btn');
    if(b){ e.preventDefault(); flip(); b.blur?.(); }
  });

  // Install button(s)
  installButtons.forEach(btn=>btn.addEventListener('click', ()=>{
    setTimeout(async () => {
      if (deferredPrompt) {
        try { await deferredPrompt.prompt(); await deferredPrompt.userChoice; ga('event','install_prompt',{status:'prompted'}); }
        catch {}
        deferredPrompt = null; return;
      }
      if (isIOS() && !isStandalone()) { $('#ios-install-prompt')?.classList?.add('is-visible'); return; }
      // fallback non bloccante
      setTimeout(()=>{ console.info('Suggerimento: usa "Aggiungi a schermata Home" dal menu del browser.'); }, 0);
    }, 0);
  }));

  // ===== CHIPS RAPIDI (UTM + messaggi) =====
  const buildMsg = (who, link) => {
    if (who==='agency')  return `Ciao Digital Tower! Vorrei prenotare una consulenza gratuita. Possiamo sentirci? ${link}`;
    return `Ciao Roberto! Vorrei lavorare con te. Possiamo sentirci? ${link}`;
    };
  const waUrl = (phone, who, utmMedium) => {
    const link = withUTM(CANON,{utm_source:'whatsapp',utm_medium:utmMedium,utm_campaign:'business-card',src:'whatsapp'});
    return `https://wa.me/${phone}?text=${encodeURIComponent(buildMsg(who, link))}`;
  };
  const mailUrl = (to, who, utmMedium) => {
    const link = withUTM(CANON,{utm_source:'email',utm_medium:utmMedium,utm_campaign:'business-card',src:'email'});
    const subject = 'Consulenza gratuita';
    const body = (who==='agency'
      ? `Ciao Digital Tower,%0D%0A%0D%0Avorrei prenotare una consulenza gratuita.%0D%0A%0D%0AGrazie!%0D%0A%0D%0ALink: ${link}`
      : `Ciao Roberto,%0D%0A%0D%0Avorrei lavorare con te.%0D%0A%0D%0AGrazie!%0D%0A%0D%0ALink: ${link}`);
    return `mailto:${to}?subject=${encodeURIComponent(subject)}&body=${body}`;
  };

  // Aggancio chips AGENCY
  $('#chip-wa-agency')  ?.setAttribute('href', waUrl('393770439955','agency','chip'));
  $('#chip-mail-agency')?.setAttribute('href', mailUrl('info@digitaltower.it','agency','chip'));
  $('#chip-call-agency')?.setAttribute('href', 'tel:+393770439955');

  // Aggancio chips PERSONAL
  $('#chip-wa-personal')  ?.setAttribute('href', waUrl('393278525595','personal','chip'));
  $('#chip-mail-personal')?.setAttribute('href', mailUrl('roberto.esposito.er@gmail.com','personal','chip'));
  $('#chip-call-personal')?.setAttribute('href', 'tel:+393278525595');

  // ===== CTA CONSULENZA =====
  const applyDefaultDurationSelection = () => {
    const recommended = (source.toLowerCase() === 'nfc') ? '30' : '15';
    durationChips.forEach(c => c.setAttribute('aria-pressed','false'));
    const target = [...durationChips].find(c => c.dataset.min === recommended) || durationChips[0];
    if (target) target.setAttribute('aria-pressed','true');
  };

  const autofocusConsultForm = () => {
    try { consultName?.focus({ preventScroll: true }); } catch(_) { consultName?.focus(); }
    if (isMobile()) {
      const box = document.querySelector('#consult-overlay .prompt-box');
      (box || consultName)?.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
  };

  const openConsult = () => {
    applyDefaultDurationSelection();
    consultOverlay?.classList?.remove('hidden');
    setTimeout(autofocusConsultForm, 60);
  };

  $$('.cta-consulenza').forEach(btn => btn.addEventListener('click', () => {
    if (CALENDLY_URL) {
      const url = withUTM(CALENDLY_URL,{utm_source:'cta',utm_medium:'scheduler',utm_campaign:'business-card',src:'cta'});
      window.open(url, '_blank', 'noopener');
      ga('event','cta_scheduler');
      return;
    }
    openConsult(); ga('event','cta_overlay');
  }));

  // Selezione durata
  durationChips.forEach(chip => {
    chip.addEventListener('click', () => {
      durationChips.forEach(c => c.setAttribute('aria-pressed','false'));
      chip.setAttribute('aria-pressed','true');
    });
  });
  const getSelectedMinutes = () => Number(
    [...durationChips].find(c => c.getAttribute('aria-pressed')==='true')?.dataset.min || 15
  );

  // Prefill messaggio
  const prefillBySource = {
    nfc: "Ti contatto dopo aver toccato la tua card NFC.",
    whatsapp: "Ti contatto da WhatsApp.",
    telegram: "Ti contatto da Telegram.",
    facebook: "Ti contatto da Facebook.",
    email: "Ti contatto dalla tua email.",
    direct: "Vorrei maggiori informazioni su una consulenza."
  };
  if (!consultMessage?.value) consultMessage.value = prefillBySource[source] || prefillBySource.direct;

  // ICS
  function downloadICS(startDate, minutes, title, description){
    const end = new Date(startDate.getTime()+minutes*60000);
    const fmt = d=>d.toISOString().replace(/[-:]/g,'').split('.')[0]+'Z';
    const cardLink = withUTM(CANON,{utm_source:'calendar',utm_medium:'ics',utm_campaign:'business-card',src:'calendar'});
    const ics = [
      'BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//DigitalTower//DigitalCard//IT',
      'BEGIN:VEVENT',`UID:${Date.now()}@digitaltower.it`,`DTSTAMP:${fmt(new Date())}`,
      `DTSTART:${fmt(startDate)}`,`DTEND:${fmt(end)}`,`SUMMARY:${title}`,
      `DESCRIPTION:${description} \\n\\nCard: ${cardLink}`, 'LOCATION:Online',
      'BEGIN:VALARM','TRIGGER:-PT24H','ACTION:DISPLAY','DESCRIPTION:Promemoria','END:VALARM',
      'BEGIN:VALARM','TRIGGER:-PT3H','ACTION:DISPLAY','DESCRIPTION:Promemoria','END:VALARM',
      'END:VEVENT','END:VCALENDAR'
    ].join('\r\n');
    const blob=new Blob([ics],{type:'text/calendar;charset=utf-8'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='consulenza.ics'; document.body.appendChild(a); a.click(); a.remove();
  }

  // Submit form consulenza (tutto asincrono → handler leggero)
  consultForm?.addEventListener('submit', (e)=>{
    e.preventDefault();
    const btn=consultForm.querySelector('button');
    consultStatus && (consultStatus.textContent='Invio in corso...'); consultStatus && (consultStatus.style.color='white');
    btn && (btn.disabled=true);

    setTimeout(async () => {
      try{
        if(!consultName?.value?.trim() || !consultEmail?.value?.trim() || !consultPhone?.value?.trim() || !consultSubject?.value?.trim() || !consultMessage?.value?.trim()){
          if (consultStatus){ consultStatus.textContent='Compila tutti i campi obbligatori.'; consultStatus.style.color='#ff4d4d'; }
          btn && (btn.disabled=false); return;
        }
        const d = consultDate?.value, t = consultTime?.value;
        if(!d || !t){ if (consultStatus) consultStatus.textContent='Seleziona data e ora.'; btn && (btn.disabled=false); return; }
        const minutes = getSelectedMinutes();
        const start = new Date(`${d}T${t}`);

        const payload = Object.fromEntries(new FormData(consultForm).entries());
        const subject = consultSubject.value || `Consulenza gratuita (${minutes} min)`;
        const msg = `Oggetto: ${subject}\nNome: ${payload.name}\nEmail: ${payload.email}\nTelefono: ${payload.phone}\n\n${payload.message}\n\nDurata: ${minutes} min\nData: ${d}\nOra: ${t}`;
        const body = { name: payload.name, email: payload.email, message: msg, origin: payload.origin || source };

        const res = await fetch(fnUrl('send-contact'), { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body), mode:'cors' });
        const json = await res.json().catch(()=>({}));
        if(!res.ok) throw new Error(json.message||'Si è verificato un errore durante l’invio.');

        downloadICS(start, minutes, subject, 'Call di consulenza gratuita');
        if (consultStatus){ consultStatus.textContent = 'Richiesta inviata! Promemoria scaricato.'; consultStatus.style.color='var(--primary-color)'; }
        consultForm.reset(); setTimeout(()=>{ consultOverlay?.classList?.add('hidden'); if (consultStatus) consultStatus.textContent=''; }, 2400);
        ga('event','consult_submit',{status:'success',minutes});
      }catch(err){
        if (consultStatus){ consultStatus.textContent='Oops! '+(err?.message||'Errore'); consultStatus.style.color='#ff4d4d'; }
        ga('event','consult_submit',{status:'error'});
      }finally{ btn && (btn.disabled=false); }
    }, 0);
  });

  // ===== SAVE OVERLAY LOGIC =====
  const currentProfile = () => cardFlipper?.classList?.contains('is-flipped') ? 'personal' : 'agency';
  const downloadVCF = () => {
    const isPersonal = currentProfile()==='personal';
    const file = isPersonal ? 'roberto_personal.vcf' : 'roberto_business.vcf';
    const a=document.createElement('a'); a.href=file; a.download=file; document.body.appendChild(a); a.click(); a.remove();
    ga('event','save_vcf',{profile:isPersonal?'personal':'agency'});
  };
  const walletAvailable = Boolean(APPLE_PASS_URL || GOOGLE_WALLET_JWT);
  const openWallet = () => {
    // tutto non bloccante
    setTimeout(() => {
      if (isIOS() && APPLE_PASS_URL){
        ga('event','wallet_open',{type:'apple'});
        window.location.href = APPLE_PASS_URL;
        return;
      }
      if (GOOGLE_WALLET_JWT){
        const saveUrl = `https://pay.google.com/gp/v/save/${encodeURIComponent(GOOGLE_WALLET_JWT)}`;
        ga('event','wallet_open',{type:'google'});
        window.open(saveUrl, '_blank', 'noopener');
        return;
      }
      // placeholder silenzioso
      console.info('Wallet: funzione in arrivo (configurare .pkpass o Google Wallet JWT).');
    }, 0);
  };
  const triggerInstall = async () => {
    setTimeout(async () => {
      if (deferredPrompt) {
        try { await deferredPrompt.prompt(); await deferredPrompt.userChoice; ga('event','install_prompt',{from:'save_overlay'}); }
        catch {}
        deferredPrompt = null; return;
      }
      if (isIOS() && !isStandalone()) { $('#ios-install-prompt')?.classList?.add('is-visible'); return; }
      console.info('Per installare: usa il menu del browser → “Aggiungi a schermata Home”.');
    }, 0);
  };
  const copyLink = async () => {
    const url = withUTM(CANON,{utm_source:'copy',utm_medium:'save_overlay',utm_campaign:'business-card',src:'save'});
    try { await navigator.clipboard.writeText(url); return true; } catch { return false; }
  };

  // Aggiorna label Wallet se non disponibile
  const walletChip = $('#chip-add-wallet')?.querySelector('span');
  if (walletChip && !walletAvailable) walletChip.textContent = 'Funzione in arrivo';

  // Bottoni icona SAVE/SHARE per FRONT/BACK (niente inversione)
  const bindSave = (btnId) => {
    const b = document.getElementById(btnId);
    if (!b) return;
    b.addEventListener('click', ()=>{
      play(sfxClick);
      saveOverlay?.classList?.remove('hidden');
      // rimuovi pulse su entrambe le icone
      $$('.save-trigger').forEach(x=>x?.classList?.remove('pulse'));
    });
  };
  const bindShare = (btnId) => {
    const b = document.getElementById(btnId);
    if (!b) return;
    b.addEventListener('click', ()=>{
      play(sfxClick);
      const url = withUTM(CANON,{utm_source:'native-share',utm_medium:'share',utm_campaign:'business-card',src:'native'});
      const data={title:'Digital Tower - Business Card', text:'Scopri la business card di Digital Tower!', url};
      setTimeout(async () => {
        if(navigator.share){
          try { await navigator.share(data); ga('event','share_native'); return; }
          catch(e){ if(e && e.name==='AbortError') return; }
        }
        shareOverlay?.classList?.remove('hidden');
      }, 0);
    });
  };
  bindSave('save-trigger-front');
  bindSave('save-trigger-back');
  bindShare('share-trigger-front');
  bindShare('share-trigger-back');

  // Chips nel popup
  $('#chip-save-contact')?.addEventListener('click', ()=>{ downloadVCF(); });
  $('#chip-add-wallet') ?.addEventListener('click', ()=>{ openWallet(); });
  $('#chip-install-app')?.addEventListener('click', ()=>{ triggerInstall(); });
  $('#chip-copy-link')  ?.addEventListener('click', async (e)=>{
    const ok = await copyLink();
    const chip = e.currentTarget;
    if (ok) { chip?.classList?.add('copied'); setTimeout(()=>chip?.classList?.remove('copied'), 1200); }
    else {
      // fallback non bloccante
      const span = chip?.querySelector('span'); if (!span) return;
      const old = span.textContent; span.textContent = 'Copiato!';
      setTimeout(()=>{ span.textContent = old; }, 1200);
    }
  });

  // ===== PULSE dopo 5s di inattività =====
  let idleTimer = null;
  const resetIdle = () => {
    if (idleTimer) clearTimeout(idleTimer);
    $$('.save-trigger').forEach(b=>b?.classList?.remove('pulse'));
    idleTimer = setTimeout(()=>{
      $$('.save-trigger').forEach(b=>b?.classList?.add('pulse'));
    }, 5000);
  };
  ['mousemove','keydown','touchstart','scroll','click'].forEach(evt=>{
    window.addEventListener(evt, resetIdle, {passive:true});
  });
  resetIdle(); // avvia il timer all’inizio

  // SHARE init + install + page_ready
  updateShareLinks();
  attachShareTriggers(); // (mantiene anche share da overlay desktop)
  showInstallPrompt();
  ga('event','page_ready',{ page_location: location.href });

  // Service Worker
  if('serviceWorker' in navigator){
    window.addEventListener('load', ()=>{
      const base = location.pathname.endsWith('/') ? location.pathname : location.pathname.substring(0, location.pathname.lastIndexOf('/')+1);
      const swUrl = `${base}service-worker.js`;
      navigator.serviceWorker.register(swUrl)
        .then(()=>console.log('Service worker registrato:', swUrl))
        .catch(err=>console.error('Errore registrazione service worker:', err));
    });
  }
});
